<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
/**
 * @brief Главная функция, которая запускается, когда страничка загрузилась
 * @return ничего
 */
$(document).ready(function() {
    console.log('client Email: ', emailFromGet);
    if (emailFromGet.split("@")[1] != '1553.ru') {
        $('#loader').attr('hidden', true);
        $('#wrongAcc').attr('hidden', false);
        return;
    }
    google.script.run
        .withFailureHandler(function(e) {
            console.log(e.message, e);
        })
        .withSuccessHandler(onSheetsRecieved)
        .getSheets(emailFromGet);

});

$("#relogin").click(relogin);

/**
 * @brief Заставляет выйти из гугл-аккаунта и войти нормально
 * @return Ничего не возвращает
 */
function relogin() {
    var newWindow = window.open(
        'https://mail.google.com/mail/?logout&hl=fr',
        'Disconnect from Google', 'width=500,height=400,menubar=no,status=no,location=no,toolbar=no,scrollbars=no,top=200,left=200'
    );
    setTimeout(function() {
        if (newWindow)
            newWindow.close();
        var url = "https://accounts.google.com/ServiceLogin/signinchooser?passive=1209600&continue=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbwYVmAvO5vg13Grk_5bLtfE6ms-ZNjzQ8aaqbnAcESOcIu9DHQa%2Fexec&followup=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbwYVmAvO5vg13Grk_5bLtfE6ms-ZNjzQ8aaqbnAcESOcIu9DHQa%2Fexec&flowName=GlifWebSignIn&flowEntry=ServiceLogin";
        window.open(url, '_top');
    }, 1000);
}

/**
 * @brief Успешное получение списка листов
 * @param [in|out] String[] sheets Названия листов
 * @see getSheets()
 */
function onSheetsRecieved(sheets) {
    $('#loader').attr('hidden', true);
    $('#main').attr('hidden', false);

    for (var i in sheets) {
        var data = google.script.run
            .withFailureHandler(onGetDataFailed)
            .withSuccessHandler(onGetDataRecieved)
            .getData(sheets[i], emailFromGet, 'email');
    }
}

/**
 * @brief Обработка ошибок, если загрузить лист не удалось
 */
function onGetDataFailed(e) {
    console.log("error!", e.message, e);
}

/**
 * @brief Флаг отвечающий за установку вкладки по умолчанию (первая загруженная - ставится по-умолчанию)
 */
var isFirstTab = true;

/**
 * @brief Обработка полученных данных отдельного листа
 * @param [in] Object msg данные и метаданные отдельного листа
 * @see  getData(sheetName, id, id_label)
 */
function onGetDataRecieved(msg) {
    console.log(msg);

    if(msg.data.length < 1) return;

    var navItem = "<li class='nav-item'><a data-toggle='tab' role='tab' class='nav-link' href='#" + msg.sheetId + "'  id='" + msg.sheetId + "_tab'  aria-controls='" + msg.sheetId + "' aria-selected=" + isFirstTab + ">" + msg.sheetName + "</a></li>";
    var tabPanel = "<div role='tabpanel' class='tab-pane" + (isFirstTab ? " show" : "") + "' id='" + msg.sheetId + "' aria-labelledby='" + msg.sheetId + "_tab' ></div>";

    $('#menu').append(navItem);
    $('#content').append(tabPanel);
    if(isFirstTab)
        $('#'+msg.sheetId+'_tab').click();
    isFirstTab = false;

    try{
        drawer[msg.sheetLayout](msg.sheetId, msg.data);
    }catch(e){
        console.log(e);
        drawer['table'](msg.sheetId, msg.data);
    }

}

/**
 * @brief Рисовальщик - содержит функции рисующие данные как надо на основе параметра sheetLayout
 */
var drawer = {
        /**
         * @brief Рисует табличку при помощи библиотеки Tabulator
         * @param [in] String id Идентефикатор элемента, внутрь которого надо добавить табличку
         * @param [in] String data Содержимое таблички
         */
        table: function(id, data) {
            var tableId = id+'_table';
            $("#"+id).append('<div class="row" id="'+tableId+'"></div>');
            var table = new Tabulator("#"+tableId, {
                //        height: 300,
                data: data,
                autoColumns:true,
                selectable: true,
                layout:"fitDataTable",
                responsiveLayout:"collapse",
                rowSelectionChanged: function(data, rows) {
                    console.log(data, rows);
                },
            });
        },

        /**
         * @brief Сваливает всё просто в кучу - оставляет возможность форматировать из базы данных
         * @param [in] String id Идентефикатор элемента, внутрь которого надо добавить табличку
         * @param [in] String data Содержимое таблички
         */
        plainText: function(id, data){
            var html = '';
            for(var i in data){
                for(j in data[i]){
                    html += data[i][j] + ' ';
                }
            }
            $('#'+id).html(html);
        }
    };

    /**
     * @brief Сравнение дат без учёта времени
     * @param [in] Date a Дата
     * @param [in] Date b Дата
     * @return 0 если даты одинаковые, 1 если больше а, -1 если больше b
     */
    function daysCompare(a, b) {
        if ((a.getFullYear() * 10000 + a.getMonth() * 100 + a.getDate()) - (b.getFullYear() * 10000 + b.getMonth() * 100 + b.getDate()) > 0) return 1;
        if ((a.getFullYear() * 10000 + a.getMonth() * 100 + a.getDate()) - (b.getFullYear() * 10000 + b.getMonth() * 100 + b.getDate()) < 0) return -1;
        return 0;
    }

    /**
     * @brief Форматирует дату в виде красивого текста
     * @param [in] Date date Дата
     * @return текстовая строка с датой
     */
    function formatDate(date) {
        return new Date(date).toLocaleString('ru', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
    }

    /**
     * @brief Форматирует время в виде красивого текста
     * @param [in] Date t время
     * @return текстовая строка со временем
     */
    function formatTime(t) {
        return new Date(t).toLocaleString('ru', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.1/dist/js/tabulator.min.js"></script>
