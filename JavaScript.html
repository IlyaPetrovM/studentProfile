<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.1/dist/js/tabulator.min.js"></script>

<!-- include codemirror (codemirror.css, codemirror.js, xml.js, formatting.js) -->
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/3.20.0/codemirror.css">
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/3.20.0/theme/monokai.css">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/codemirror/3.20.0/codemirror.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/codemirror/3.20.0/mode/xml/xml.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/codemirror/2.36.0/formatting.js"></script>

<!-- include summernote css/js -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ru-RU.min.js"></script>

<script>
    /**
     * @brief Главная функция, которая запускается, когда страничка загрузилась
     * @return ничего
     */
    $(document).ready(function() {
        console.log('client Email: ', emailFromGet);
        if (emailFromGet.split("@")[1] != '1553.ru') {
            $('#loader').attr('hidden', true);
            $('#wrongAcc').attr('hidden', false);
            return;
        }
        google.script.run
            .withFailureHandler(function(e) {
                console.log(e.message, e);
            })
            .withSuccessHandler(onSheetsRecieved)
            .getSheets(emailFromGet);
    });

    $("#relogin").click(relogin);

    /**
     * @brief Заставляет выйти из гугл-аккаунта и войти нормально
     * @return Ничего не возвращает
     */
    function relogin() {
        var newWindow = window.open(
            'https://mail.google.com/mail/?logout&hl=fr',
            'Disconnect from Google', 'width=500,height=400,menubar=no,status=no,location=no,toolbar=no,scrollbars=no,top=200,left=200'
        );
        setTimeout(function() {
            if (newWindow)
                newWindow.close();
            var url = "https://accounts.google.com/ServiceLogin/signinchooser?passive=1209600&continue=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbwYVmAvO5vg13Grk_5bLtfE6ms-ZNjzQ8aaqbnAcESOcIu9DHQa%2Fexec&followup=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbwYVmAvO5vg13Grk_5bLtfE6ms-ZNjzQ8aaqbnAcESOcIu9DHQa%2Fexec&flowName=GlifWebSignIn&flowEntry=ServiceLogin";
            window.open(url, '_top');
        }, 1000);
    }

    /**
     * @brief Успешное получение списка листов
     * @param [in|out] String[] sheets Названия листов
     * @see getSheets()
     */
    var editor = '';

    function createTab(msg) {
        var navItem = "<li class='nav-item'><a data-toggle='tab' role='tab' class='nav-link' href='#" + msg.sheetId + "'  id='" + msg.sheetId + "_tab'  aria-controls='" + msg.sheetId + "' aria-selected=" + isFirstTab + ">" + msg.sheetName + "</a></li>";
        var tabPanel = "<div role='tabpanel' class='tab-pane" + (isFirstTab ? " show" : "") + "' id='" + msg.sheetId + "' aria-labelledby='" + msg.sheetId + "_tab' ></div>";

        $('#menu').append(navItem);
        $('#content').append(tabPanel);
        if (isFirstTab)
            $('#' + msg.sheetId + '_tab').click();
        isFirstTab = false;
    }

    function onSheetsRecieved(sheets) {

        $('#loader').attr('hidden', true);
        $('#main').attr('hidden', false);

        if (editModeOn == 'true') {
            for (var i in sheets) {
                google.script.run
                    .withFailureHandler(onGetDataFailed)
                    .withSuccessHandler(function(msg) {
                        console.log(msg);

                        if (msg.fields.length < 1) return;

                        createTab(msg);
                        try {
                            drawer[msg.sheetLayout](msg.sheetId, msg.fields, msg.format, msg.sheetName);
                        } catch (e) {
                            console.log(e);
                            drawer['table'](msg.sheetId, msg.fields);
                        }
                    })
                    .getDataTemplate(sheets[i]);
            }
        } else {
            for (var i in sheets) {
                var data = google.script.run
                    .withFailureHandler(onGetDataFailed)
                    .withSuccessHandler(onGetDataRecieved)
                    .getData(sheets[i], emailFromGet, 'email');
            }
        }

    }

    /**
     * @brief Обработка ошибок, если загрузить лист не удалось
     */
    function onGetDataFailed(e) {
        console.log("error!", e.message, e);
    }

    /**
     * @brief Флаг отвечающий за установку вкладки по умолчанию (первая загруженная - ставится по-умолчанию)
     */
    var isFirstTab = true;

    /**
     * @brief Обработка полученных данных отдельного листа
     * @param [in] Object msg данные и метаданные отдельного листа
     * @see  getData(sheetName, id, id_label)
     */
    function onGetDataRecieved(msg) {
        console.log(msg);

        if (msg.data.length < 1) return;

        createTab(msg);

        try {
            drawer[msg.sheetLayout](msg.sheetId, msg.data, msg.format);
        } catch (e) {
            console.log(e);
            drawer['table'](msg.sheetId, msg.data);
        }

    }

    /**
     * @brief Рисовальщик - содержит функции рисующие данные как надо на основе параметра sheetLayout
     */
    var drawer = {
        /**
         * @brief Рисует табличку при помощи библиотеки Tabulator
         * @param [in] String id Идентефикатор элемента, внутрь которого надо добавить табличку
         * @param [in] String data Содержимое таблички
         */
        table: function(id, data, format) {
            var t = document.createElement('div');
            t.id = id+'_table'
            $('#' + id).append(t);
            var table = new Tabulator("#" + t.id, {
                //        height: 300,
                data: data,
                autoColumns: true,
                selectable: true,
                layout: "fitDataTable",
                responsiveLayout: "collapse",
                rowSelectionChanged: function(data, rows) {
                    console.log(data, rows);
                },
            });
        },

        /**
         * @brief Сваливает всё просто в кучу - оставляет возможность форматировать из базы данных
         * @param [in] String id Идентефикатор элемента, внутрь которого надо добавить табличку
         * @param [in] String data Содержимое таблички
         */
        plainText: function(id, data) {
            var html = '';
            for (var i in data) {
                for (j in data[i]) {
                    html += '<p>' + data[i][j] + '</p>';
                }
            }
            $('#' + id).html(html);
        },
        /**
            TODO
         */
        template: function(id, data, format,sheetName) {

            if (editModeOn == 'true') { // TODO wysiwig

                $('#' + id).append(document.createElement('div'));
                $('#'+id+' div').eq(0).html(format);
                $('#'+id+' div').eq(0).summernote({
                    focus: true, // set focus to editable area after initializing summernote
                    lang: 'ru-RU',
                    codemirror: { // codemirror options
                        theme: 'monokai'
                    },
                    callbacks: {
                        onChange: function(contents, $editable) {
                            console.log('onChange ' + id, contents, $editable);
                        },
                        onChangeCodeview: function(contents, $editable) {
                            console.log('onChangeCode ' + id, contents, $editable);
                        }
                    }
                });
                console.log('#'+id+' div',format);

                var saveButton = document.createElement('div');
                saveButton.innerHTML = 'Сохранить';
                saveButton.setAttribute('type','button');
                saveButton.onclick = function(e){
                    saveButton.innerHTML = 'Отправка...';
                    var html = $('#'+id+' div').eq(0).summernote('code');
                    $('#'+id+' div').eq(0).summernote('destroy');
                    console.log(html);
                    google.script.run
                        .withFailureHandler(function(){alert("Произошла ошибка при сохранении")})
                        .withSuccessHandler(function(){saveButton.innerHTML = 'Готово!';
                                                      setTimeout(function(){saveButton.innerHTML = 'Сохранить'},1000)})
                        .saveTemplate(sheetName, html);
                };
                var editButton = document.createElement('div');
                editButton.onclick = function(e){
                    $('#'+id+' div').eq(0).summernote({focus: true});
                };
                editButton.innerHTML = 'Редактировать';
                editButton.setAttribute('type','button');
                saveButton.className = 'btn btn-success';
                editButton.className = 'btn btn-warning';
                $('#' + id).append(editButton);
                $('#' + id).append(saveButton);
                var b_grp = document.createElement('div');
                $('#' + id).append(b_grp);
                for(var i in data){
                    var b = document.createElement('div');
                    b.innerHTML = '#'+data[i];
                    b.setAttribute('type','button');
                    b.className = 'btn btn-outline-secondary';
                    b.onclick = function(i){
                        console.log('#'+this[i]);
                        $('#'+id+' div').eq(0).summernote('pasteHTML', '<span class="badge badge-secondary" contenteditable=false id="'+id+'_'+this[i]+'"> #'+this[i]+'</span> &zwnj;');

                    }.bind(data,i);
                    b_grp.append(b);
                }

            }else{
                $('#' + id).html(format);
                $('#' + id+ ' span').attr('class', '');
                for(var colName in data[0]){
                    var elId = '#'+id+'_'+colName;
                    $(elId).html(data[0][colName]);
                }
            }
        }
    };

    /**
     * @brief Сравнение дат без учёта времени
     * @param [in] Date a Дата
     * @param [in] Date b Дата
     * @return 0 если даты одинаковые, 1 если больше а, -1 если больше b
     */
    function daysCompare(a, b) {
        if ((a.getFullYear() * 10000 + a.getMonth() * 100 + a.getDate()) - (b.getFullYear() * 10000 + b.getMonth() * 100 + b.getDate()) > 0) return 1;
        if ((a.getFullYear() * 10000 + a.getMonth() * 100 + a.getDate()) - (b.getFullYear() * 10000 + b.getMonth() * 100 + b.getDate()) < 0) return -1;
        return 0;
    }

    /**
     * @brief Форматирует дату в виде красивого текста
     * @param [in] Date date Дата
     * @return текстовая строка с датой
     */
    function formatDate(date) {
        return new Date(date).toLocaleString('ru', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
    }

    /**
     * @brief Форматирует время в виде красивого текста
     * @param [in] Date t время
     * @return текстовая строка со временем
     */
    function formatTime(t) {
        return new Date(t).toLocaleString('ru', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

</script>
